# Learn2Grow Email System Documentation

## Overview
The Learn2Grow Email System provides automated email functionality for the platform, handling:
- New recipient registration confirmations
- Admin notifications for new recipient requests
- Approval emails for verified recipients
- Verification request emails for recipients requiring additional information

## Configuration

### Environment Setup
The system uses Gmail SMTP for sending emails. Configure the following in `.env`:

```
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_SECURE=false
EMAIL_USER=learn2growad1@gmail.com
EMAIL_PASS=your_app_password_from_google
ADMIN_EMAIL=learn2growad1@gmail.com
```

### Setting Up Google App Password
For security, Gmail requires an App Password instead of your regular password:

1. Go to https://myaccount.google.com/security
2. Enable 2-Step Verification if not already enabled
3. Go to "App passwords" (under "Signing in to Google")
4. Create a new app password for "Mail" and "Other (Custom name)" - name it "Learn2Grow"
5. Copy the generated password and paste it in your `.env` file as `EMAIL_PASS` value
6. Make sure to remove any spaces from the generated password

## System Components

### Email Service (`utils/emailService.js`)
Core component that handles email creation and sending:
- Creates email transporter using nodemailer
- Provides functions for different email types
- Handles development mode (logs emails) vs production mode (sends emails)

### Email Automation (`utils/emailAutomation.js`)
Manages email workflows and database record keeping:
- Processes new recipient requests
- Sends approval emails
- Sends verification emails
- Tracks email sending status in the database

### Scheduled Emails (`scheduledEmails.js`)
Automated email processing script that:
- Connects to the database
- Processes all pending emails
- Logs statistics about email operations
- Can be run on a schedule using cron or other job scheduler

## Testing Tools

### Test Files
Several scripts are available to test the email system:

1. `testEmail.js` - Basic email testing
2. `testEmailProduction.js` - Test with production settings
3. `testRecipientEmails.js` - Test emails using database records
4. `testRealEmail.js` - Direct Gmail SMTP testing
5. `sendAutomatedEmails.js` - Manual batch processing

## Running the System

### Manual Processing
To manually process pending emails:
```bash
# Process all pending emails
node sendAutomatedEmails.js

# Force processing of all emails, even already sent ones
node sendAutomatedEmails.js --force
```

### Test Real Email Sending
To verify SMTP connectivity with Gmail:
```bash
# Send a test email to the default address
node testRealEmail.js

# Test without actually sending (simulation mode)
node testRealEmail.js --test

# Send to a specific email address
node testRealEmail.js --to=recipient@example.com
```

### Scheduled Processing
To run the automated email processing:

#### Run Once:
```bash
# Run once and exit
node scheduledEmails.js --once
```

#### Run Continuously:
```bash
# Run every hour (default)
node scheduledEmails.js

# Run every 5 minutes
node scheduledEmails.js --interval=5
```

#### Using cron:
```bash
0 * * * * cd /path/to/Learn2Grow && node scheduledEmails.js --once >> logs/emails.log 2>&1
```

#### Using PM2 (recommended for production):
```bash
# Start as a persistent service
pm2 start scheduledEmails.js --name "learn2grow-emails"

# Or with specific interval (in minutes)
pm2 start scheduledEmails.js --name "learn2grow-emails" -- --interval=30
```

## Troubleshooting

### Common Issues
1. **Emails not sending**: Check if the app password is correct and properly set in .env
2. **Gmail blocking**: Ensure "Less secure app access" is enabled or using an App Password
3. **Rate limiting**: Gmail limits the number of emails per day for standard accounts

### Logging
Email operations are logged with detailed information:
- Check console output for immediate feedback
- In production, configure a proper logging system
